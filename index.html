<!DOCTYPE html>
 <html>
 
   <head>
     <title>Streetex</title>
     <script src="https://unpkg.com/maplibre-gl@^5.4.0/dist/maplibre-gl.js"></script>
     <link href="https://unpkg.com/maplibre-gl@^5.4.0/dist/maplibre-gl.css" rel="stylesheet" />
     <link rel="stylesheet" href="styles.css">
 
   </head>
 
   <body>
   
<script>
  var map = new maplibregl.Map({
    container: 'map',
    style: 'https://api.protomaps.com/styles/v5/light/en.json?key=50ad6769afe3dbd6',
    center: [21, 0],
    zoom: 17,
    pitch: 60,
    bearing: 0,
    antialias: true
  });

  map.addControl(new maplibregl.NavigationControl());

  const userMarker = new maplibregl.Marker({ color: 'red' });

  let currentHeading = 0;

  // Try to get compass heading
  if (window.DeviceOrientationEvent) {
    window.addEventListener('deviceorientationabsolute', (event) => {
      if (event.absolute && event.alpha !== null) {
        currentHeading = 360 - event.alpha;
      }
    }, true);
  }

  // Load saved path from localStorage
  let saved = localStorage.getItem('userPath');
  let userPath = saved ? JSON.parse(saved) : {
    type: 'Feature',
    geometry: {
      type: 'LineString',
      coordinates: []
    }
  };

  // When map is ready, add the line layer
  map.on('load', () => {
    map.addSource('user-path', {
      type: 'geojson',
      data: userPath
    });

    map.addLayer({
      id: 'user-path-line',
      type: 'line',
      source: 'user-path',
      layout: {
        'line-cap': 'round',
        'line-join': 'round'
      },
      paint: {
        'line-color': '#ff0000',
        'line-width': 4
      }
    });
  });

  // Update location and path
  if ('geolocation' in navigator) {
    navigator.geolocation.watchPosition(
      (position) => {
        const { latitude, longitude } = position.coords;
        const userLocation = [longitude, latitude];

        // Update marker
        userMarker.setLngLat(userLocation).addTo(map);

        // Update path
        userPath.geometry.coordinates.push(userLocation);

        // Save path to localStorage
        localStorage.setItem('userPath', JSON.stringify(userPath));

        // Update map source
        const source = map.getSource('user-path');
        if (source) source.setData(userPath);

        // Move camera
        map.easeTo({
          center: userLocation,
          bearing: currentHeading,
          pitch: 60,
          zoom: 17,
          duration: 1000,
          offset: [0, window.innerHeight / 4 * -1],
          easing: t => t
        });
      },
      (error) => {
        console.error('Geolocation error:', error.message);
      },
      {
        enableHighAccuracy: true,
        maximumAge: 1000,
        timeout: 5000
      }
    );
  } else {
    alert('Geolocation not supported by your browser.');
  }
</script>
